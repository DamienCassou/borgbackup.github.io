<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>borg.archiver &mdash; Borg - Deduplicating Archiver 0.27.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/local.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.27.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Borg - Deduplicating Archiver 0.27.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Borg - Deduplicating Archiver 0.27.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for borg.archiver</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">.support</span> <span class="kn">import</span> <span class="n">argparse</span>  <span class="c"># see support/__init__.py docstring</span>
                               <span class="c"># DEPRECATED - remove after requiring py 3.4</span>

<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">hexlify</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">attrgetter</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">.archive</span> <span class="kn">import</span> <span class="n">Archive</span><span class="p">,</span> <span class="n">ArchiveChecker</span><span class="p">,</span> <span class="n">CHUNKER_PARAMS</span>
<span class="kn">from</span> <span class="nn">.compress</span> <span class="kn">import</span> <span class="n">Compressor</span><span class="p">,</span> <span class="n">COMPR_BUFFER</span>
<span class="kn">from</span> <span class="nn">.upgrader</span> <span class="kn">import</span> <span class="n">AtticRepositoryUpgrader</span>
<span class="kn">from</span> <span class="nn">.repository</span> <span class="kn">import</span> <span class="n">Repository</span>
<span class="kn">from</span> <span class="nn">.cache</span> <span class="kn">import</span> <span class="n">Cache</span>
<span class="kn">from</span> <span class="nn">.key</span> <span class="kn">import</span> <span class="n">key_creator</span>
<span class="kn">from</span> <span class="nn">.helpers</span> <span class="kn">import</span> <span class="n">Error</span><span class="p">,</span> <span class="n">location_validator</span><span class="p">,</span> <span class="n">format_time</span><span class="p">,</span> <span class="n">format_file_size</span><span class="p">,</span> \
    <span class="n">format_file_mode</span><span class="p">,</span> <span class="n">ExcludePattern</span><span class="p">,</span> <span class="n">IncludePattern</span><span class="p">,</span> <span class="n">exclude_path</span><span class="p">,</span> <span class="n">adjust_patterns</span><span class="p">,</span> <span class="n">to_localtime</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> \
    <span class="n">get_cache_dir</span><span class="p">,</span> <span class="n">get_keys_dir</span><span class="p">,</span> <span class="n">format_timedelta</span><span class="p">,</span> <span class="n">prune_within</span><span class="p">,</span> <span class="n">prune_split</span><span class="p">,</span> \
    <span class="n">Manifest</span><span class="p">,</span> <span class="n">remove_surrogates</span><span class="p">,</span> <span class="n">update_excludes</span><span class="p">,</span> <span class="n">format_archive</span><span class="p">,</span> <span class="n">check_extension_modules</span><span class="p">,</span> <span class="n">Statistics</span><span class="p">,</span> \
    <span class="n">is_cachedir</span><span class="p">,</span> <span class="n">bigint_to_int</span><span class="p">,</span> <span class="n">ChunkerParams</span><span class="p">,</span> <span class="n">CompressionSpec</span>
<span class="kn">from</span> <span class="nn">.remote</span> <span class="kn">import</span> <span class="n">RepositoryServer</span><span class="p">,</span> <span class="n">RemoteRepository</span>

<span class="n">has_lchflags</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;lchflags&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Archiver"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver">[docs]</a><span class="k">class</span> <span class="nc">Archiver</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="Archiver.open_repository"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.open_repository">[docs]</a>    <span class="k">def</span> <span class="nf">open_repository</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">location</span><span class="o">.</span><span class="n">proto</span> <span class="o">==</span> <span class="s">&#39;ssh&#39;</span><span class="p">:</span>
            <span class="n">repository</span> <span class="o">=</span> <span class="n">RemoteRepository</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="n">create</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">repository</span> <span class="o">=</span> <span class="n">Repository</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="n">create</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="n">exclusive</span><span class="p">)</span>
        <span class="n">repository</span><span class="o">.</span><span class="n">_location</span> <span class="o">=</span> <span class="n">location</span>
        <span class="k">return</span> <span class="n">repository</span>
</div>
<div class="viewcode-block" id="Archiver.print_error"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.print_error">[docs]</a>    <span class="k">def</span> <span class="nf">print_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">msg</span> <span class="o">%</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">msg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;borg: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Archiver.print_verbose"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.print_verbose">[docs]</a>    <span class="k">def</span> <span class="nf">print_verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">msg</span> <span class="o">%</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">msg</span>
            <span class="k">if</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;newline&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Archiver.do_serve"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.do_serve">[docs]</a>    <span class="k">def</span> <span class="nf">do_serve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start in server mode. This command is usually not used manually.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">RepositoryServer</span><span class="p">(</span><span class="n">restrict_to_paths</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">restrict_to_paths</span><span class="p">)</span><span class="o">.</span><span class="n">serve</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Archiver.do_init"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.do_init">[docs]</a>    <span class="k">def</span> <span class="nf">do_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an empty repository&quot;&quot;&quot;</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Initializing repository at &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">orig</span><span class="p">)</span>
        <span class="n">repository</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_repository</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">repository</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key_creator</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="n">Manifest</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">repository</span><span class="p">)</span>
        <span class="n">manifest</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">manifest</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="n">repository</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">Cache</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">warn_if_unencrypted</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span>
</div>
<div class="viewcode-block" id="Archiver.do_check"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.do_check">[docs]</a>    <span class="k">def</span> <span class="nf">do_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check repository consistency&quot;&quot;&quot;</span>
        <span class="n">repository</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_repository</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">repository</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">repair</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">repair</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;BORG_CHECK_I_KNOW_WHAT_I_AM_DOING&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&quot;&quot;&quot;Warning: &#39;check --repair&#39; is an experimental feature that might result</span>
<span class="s">in data loss.</span>

<span class="s">Type &quot;Yes I am sure&quot; if you understand this and want to continue.</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">input</span><span class="p">(</span><span class="s">&#39;Do you want to continue? &#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Yes I am sure&#39;</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">archives_only</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Starting repository check...&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">repository</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">repair</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">repair</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Repository check complete, no problems found.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">repo_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ArchiveChecker</span><span class="p">()</span><span class="o">.</span><span class="n">check</span><span class="p">(</span>
                <span class="n">repository</span><span class="p">,</span> <span class="n">repair</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">repair</span><span class="p">,</span> <span class="n">archive</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">archive</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">last</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="Archiver.do_change_passphrase"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.do_change_passphrase">[docs]</a>    <span class="k">def</span> <span class="nf">do_change_passphrase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change repository key file passphrase&quot;&quot;&quot;</span>
        <span class="n">repository</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_repository</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">repository</span><span class="p">)</span>
        <span class="n">manifest</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Manifest</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
        <span class="n">key</span><span class="o">.</span><span class="n">change_passphrase</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="Archiver.do_create"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.do_create">[docs]</a>    <span class="k">def</span> <span class="nf">do_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new archive&quot;&quot;&quot;</span>
        <span class="n">dry_run</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dry_run</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">repository</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_repository</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">archive</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">manifest</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Manifest</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
            <span class="n">compr_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">buffer</span><span class="o">=</span><span class="n">COMPR_BUFFER</span><span class="p">)</span>
            <span class="n">compr_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">compression</span><span class="p">)</span>
            <span class="n">key</span><span class="o">.</span><span class="n">compressor</span> <span class="o">=</span> <span class="n">Compressor</span><span class="p">(</span><span class="o">**</span><span class="n">compr_args</span><span class="p">)</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">do_files</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cache_files</span><span class="p">)</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="n">Archive</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">archive</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
                              <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">checkpoint_interval</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">checkpoint_interval</span><span class="p">,</span>
                              <span class="n">numeric_owner</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">numeric_owner</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span>
                              <span class="n">chunker_params</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">chunker_params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="n">cache</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># Add cache dir to inode_skip list</span>
        <span class="n">skip_inodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">get_cache_dir</span><span class="p">())</span>
            <span class="n">skip_inodes</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">st</span><span class="o">.</span><span class="n">st_ino</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">st_dev</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c"># Add local repository dir to inode_skip list</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">host</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="n">skip_inodes</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">st</span><span class="o">.</span><span class="n">st_ino</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">st_dev</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>  <span class="c"># stdin</span>
                <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;stdin&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">process_stdin</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_verbose</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%1s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dontcross</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">restrict_dev</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_dev</span>
                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">restrict_dev</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">excludes</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">exclude_caches</span><span class="p">,</span> <span class="n">skip_inodes</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">restrict_dev</span><span class="p">,</span>
                          <span class="n">read_special</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">read_special</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">archive</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">timestamp</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">progress</span><span class="p">:</span>
                <span class="n">archive</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">show_progress</span><span class="p">(</span><span class="n">final</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">stats</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">t0</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">78</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Archive name: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">archive</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Archive fingerprint: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">hexlify</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Start time: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">t0</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%c</span><span class="s">&#39;</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;End time: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%c</span><span class="s">&#39;</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Duration: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">format_timedelta</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Number of files: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">archive</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">nfiles</span><span class="p">)</span>
                <span class="n">archive</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="s">&#39;This archive:&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">78</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span>
</div>
    <span class="k">def</span> <span class="nf">_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">archive</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">excludes</span><span class="p">,</span> <span class="n">exclude_caches</span><span class="p">,</span> <span class="n">skip_inodes</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">restrict_dev</span><span class="p">,</span>
                 <span class="n">read_special</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exclude_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">excludes</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_ino</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">st_dev</span><span class="p">)</span> <span class="ow">in</span> <span class="n">skip_inodes</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c"># Entering a new filesystem?</span>
        <span class="k">if</span> <span class="n">restrict_dev</span> <span class="ow">and</span> <span class="n">st</span><span class="o">.</span><span class="n">st_dev</span> <span class="o">!=</span> <span class="n">restrict_dev</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># Ignore if nodump flag is set</span>
        <span class="k">if</span> <span class="n">has_lchflags</span> <span class="ow">and</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_flags</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">UF_NODUMP</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">read_special</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">process_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">exclude_caches</span> <span class="ow">and</span> <span class="n">is_cachedir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">process_dir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">entries</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
                    <span class="n">entry_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">excludes</span><span class="p">,</span> <span class="n">exclude_caches</span><span class="p">,</span> <span class="n">skip_inodes</span><span class="p">,</span>
                                  <span class="n">entry_path</span><span class="p">,</span> <span class="n">restrict_dev</span><span class="p">,</span> <span class="n">read_special</span><span class="o">=</span><span class="n">read_special</span><span class="p">,</span>
                                  <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISLNK</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">process_symlink</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISFIFO</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">process_fifo</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISCHR</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span> <span class="ow">or</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISBLK</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">process_dev</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISSOCK</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
            <span class="c"># Ignore unix sockets</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&#39;Unknown file type: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c"># Status output</span>
        <span class="c"># A lowercase character means a file type other than a regular file,</span>
        <span class="c"># borg usually just stores them. E.g. (d)irectory.</span>
        <span class="c"># Hardlinks to already seen content are indicated by (h).</span>
        <span class="c"># A uppercase character means a regular file that was (A)dded,</span>
        <span class="c"># (M)odified or was (U)nchanged.</span>
        <span class="c"># Note: A/M/U is relative to the &quot;files&quot; cache, not to the repo.</span>
        <span class="c"># This would be an issue if the files cache is not used.</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;?&#39;</span>  <span class="c"># need to add a status code somewhere</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span>  <span class="c"># dry run, item was not backed up</span>
        <span class="c"># output ALL the stuff - it can be easily filtered using grep.</span>
        <span class="c"># even stuff considered unchanged might be interesting.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_verbose</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%1s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">remove_surrogates</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

<div class="viewcode-block" id="Archiver.do_extract"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.do_extract">[docs]</a>    <span class="k">def</span> <span class="nf">do_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract archive contents&quot;&quot;&quot;</span>
        <span class="c"># be restrictive when restoring files, restore permissions later</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;ascii&#39;</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: File system encoding is &quot;ascii&quot;, extracting non-ascii filenames will not be supported.&#39;</span><span class="p">)</span>
        <span class="n">repository</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_repository</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">archive</span><span class="p">)</span>
        <span class="n">manifest</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Manifest</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
        <span class="n">archive</span> <span class="o">=</span> <span class="n">Archive</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">archive</span><span class="p">,</span>
                          <span class="n">numeric_owner</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">numeric_owner</span><span class="p">)</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="n">adjust_patterns</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">paths</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">excludes</span><span class="p">)</span>
        <span class="n">dry_run</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dry_run</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">sparse</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sparse</span>
        <span class="n">strip_components</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">strip_components</span>
        <span class="n">dirs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">iter_items</span><span class="p">(</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="ow">not</span> <span class="n">exclude_path</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;path&#39;</span><span class="p">],</span> <span class="n">patterns</span><span class="p">),</span> <span class="n">preload</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">orig_path</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;path&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">strip_components</span><span class="p">:</span>
                <span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">orig_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="n">strip_components</span><span class="p">:])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;path&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">dirs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">dirs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">b</span><span class="s">&#39;path&#39;</span><span class="p">]):</span>
                    <span class="n">archive</span><span class="o">.</span><span class="n">extract_item</span><span class="p">(</span><span class="n">dirs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_verbose</span><span class="p">(</span><span class="n">remove_surrogates</span><span class="p">(</span><span class="n">orig_path</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                    <span class="n">archive</span><span class="o">.</span><span class="n">extract_item</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;mode&#39;</span><span class="p">]):</span>
                        <span class="n">dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="n">archive</span><span class="o">.</span><span class="n">extract_item</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">restore_attrs</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">archive</span><span class="o">.</span><span class="n">extract_item</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">remove_surrogates</span><span class="p">(</span><span class="n">orig_path</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">dirs</span><span class="p">:</span>
                <span class="n">archive</span><span class="o">.</span><span class="n">extract_item</span><span class="p">(</span><span class="n">dirs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="p">(</span><span class="n">patterns</span> <span class="ow">or</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">IncludePattern</span><span class="p">)</span> <span class="ow">and</span>  <span class="n">pattern</span><span class="o">.</span><span class="n">match_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&quot;Warning: Include pattern &#39;</span><span class="si">%s</span><span class="s">&#39; never matched.&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span>
</div>
<div class="viewcode-block" id="Archiver.do_rename"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.do_rename">[docs]</a>    <span class="k">def</span> <span class="nf">do_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rename an existing archive&quot;&quot;&quot;</span>
        <span class="n">repository</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_repository</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">archive</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">manifest</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Manifest</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">manifest</span><span class="p">)</span>
        <span class="n">archive</span> <span class="o">=</span> <span class="n">Archive</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">archive</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">)</span>
        <span class="n">archive</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">manifest</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="n">repository</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span>
</div>
<div class="viewcode-block" id="Archiver.do_delete"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.do_delete">[docs]</a>    <span class="k">def</span> <span class="nf">do_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete an existing repository or archive&quot;&quot;&quot;</span>
        <span class="n">repository</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_repository</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">manifest</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Manifest</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">do_files</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cache_files</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">archive</span><span class="p">:</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="n">Archive</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">archive</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">)</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">Statistics</span><span class="p">()</span>
            <span class="n">archive</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
            <span class="n">manifest</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">repository</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">stats</span><span class="p">:</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="s">&#39;Deleted data:&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">cache_only</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;You requested to completely DELETE the repository *including* all archives it contains:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">archive_info</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">list_archive_infos</span><span class="p">(</span><span class="n">sort_by</span><span class="o">=</span><span class="s">&#39;ts&#39;</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">format_archive</span><span class="p">(</span><span class="n">archive_info</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;BORG_CHECK_I_KNOW_WHAT_I_AM_DOING&#39;</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;&quot;&quot;Type &quot;YES&quot; if you understand this and want to continue.</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">input</span><span class="p">(</span><span class="s">&#39;Do you want to continue? &#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;YES&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span>
                <span class="n">repository</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Repository deleted.&quot;</span><span class="p">)</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Cache deleted.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span>
</div>
<div class="viewcode-block" id="Archiver.do_mount"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.do_mount">[docs]</a>    <span class="k">def</span> <span class="nf">do_mount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mount archive or an entire repository as a FUSE fileystem&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.fuse</span> <span class="kn">import</span> <span class="n">FuseOperations</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&#39;loading fuse support failed [ImportError: </span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: Mountpoint must be a writable directory&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span>

        <span class="n">repository</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_repository</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
        <span class="n">manifest</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Manifest</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">archive</span><span class="p">:</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="n">Archive</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">archive</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">operations</span> <span class="o">=</span> <span class="n">FuseOperations</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">repository</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">archive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_verbose</span><span class="p">(</span><span class="s">&quot;Mounting filesystem&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">operations</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">foreground</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="c"># Relevant error message already printed to stderr by fuse</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span>
</div>
<div class="viewcode-block" id="Archiver.do_list"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.do_list">[docs]</a>    <span class="k">def</span> <span class="nf">do_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List archive or repository contents&quot;&quot;&quot;</span>
        <span class="n">repository</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_repository</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
        <span class="n">manifest</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Manifest</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">archive</span><span class="p">:</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="n">Archive</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">archive</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">short</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">iter_items</span><span class="p">():</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">remove_surrogates</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;path&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmap</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s">&#39;p&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="n">o10</span><span class="p">:</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="n">o12</span><span class="p">:</span> <span class="s">&#39;l&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="n">o14</span><span class="p">:</span> <span class="s">&#39;s&#39;</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">iter_items</span><span class="p">():</span>
                    <span class="nb">type</span> <span class="o">=</span> <span class="n">tmap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">4096</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">)</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">format_file_mode</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;mode&#39;</span><span class="p">])</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">size</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;chunks&#39;</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">mtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">bigint_to_int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;mtime&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c"># likely a broken mtime and datetime did not want to go beyond year 9999</span>
                        <span class="n">mtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">9999</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">59</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">b</span><span class="s">&#39;source&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;l&#39;</span><span class="p">:</span>
                            <span class="n">extra</span> <span class="o">=</span> <span class="s">&#39; -&gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;source&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">type</span> <span class="o">=</span> <span class="s">&#39;h&#39;</span>
                            <span class="n">extra</span> <span class="o">=</span> <span class="s">&#39; link to </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;source&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">extra</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s%s</span><span class="s"> </span><span class="si">%-6s</span><span class="s"> </span><span class="si">%-6s</span><span class="s"> </span><span class="si">%8d</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">type</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;user&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;uid&#39;</span><span class="p">],</span>
                        <span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;group&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;gid&#39;</span><span class="p">],</span> <span class="n">size</span><span class="p">,</span> <span class="n">format_time</span><span class="p">(</span><span class="n">mtime</span><span class="p">),</span>
                        <span class="n">remove_surrogates</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;path&#39;</span><span class="p">]),</span> <span class="n">extra</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">archive_info</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">list_archive_infos</span><span class="p">(</span><span class="n">sort_by</span><span class="o">=</span><span class="s">&#39;ts&#39;</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="n">format_archive</span><span class="p">(</span><span class="n">archive_info</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span>
</div>
<div class="viewcode-block" id="Archiver.do_info"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.do_info">[docs]</a>    <span class="k">def</span> <span class="nf">do_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show archive details such as disk space used&quot;&quot;&quot;</span>
        <span class="n">repository</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_repository</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">archive</span><span class="p">)</span>
        <span class="n">manifest</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Manifest</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">do_files</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cache_files</span><span class="p">)</span>
        <span class="n">archive</span> <span class="o">=</span> <span class="n">Archive</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">archive</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">)</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">calc_stats</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Name:&#39;</span><span class="p">,</span> <span class="n">archive</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Fingerprint: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">hexlify</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Hostname:&#39;</span><span class="p">,</span> <span class="n">archive</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;hostname&#39;</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Username:&#39;</span><span class="p">,</span> <span class="n">archive</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Time: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">to_localtime</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">ts</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%c</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Command line:&#39;</span><span class="p">,</span> <span class="n">remove_surrogates</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;cmdline&#39;</span><span class="p">])))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Number of files: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">stats</span><span class="o">.</span><span class="n">nfiles</span><span class="p">)</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="s">&#39;This archive:&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span>
</div>
<div class="viewcode-block" id="Archiver.do_prune"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.do_prune">[docs]</a>    <span class="k">def</span> <span class="nf">do_prune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prune repository archives according to specified rules&quot;&quot;&quot;</span>
        <span class="n">repository</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_repository</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">repository</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">manifest</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Manifest</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">do_files</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cache_files</span><span class="p">)</span>
        <span class="n">archives</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">list_archive_infos</span><span class="p">(</span><span class="n">sort_by</span><span class="o">=</span><span class="s">&#39;ts&#39;</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c"># just a ArchiveInfo list</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">hourly</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">daily</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">weekly</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">monthly</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">yearly</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">within</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&#39;At least one of the &quot;within&quot;, &quot;keep-hourly&quot;, &quot;keep-daily&quot;, &quot;keep-weekly&quot;, &#39;</span>
                             <span class="s">&#39;&quot;keep-monthly&quot; or &quot;keep-yearly&quot; settings must be specified&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="p">:</span>
            <span class="n">archives</span> <span class="o">=</span> <span class="p">[</span><span class="n">archive</span> <span class="k">for</span> <span class="n">archive</span> <span class="ow">in</span> <span class="n">archives</span> <span class="k">if</span> <span class="n">archive</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="p">)]</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">within</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">+=</span> <span class="n">prune_within</span><span class="p">(</span><span class="n">archives</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">within</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">hourly</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">+=</span> <span class="n">prune_split</span><span class="p">(</span><span class="n">archives</span><span class="p">,</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">hourly</span><span class="p">,</span> <span class="n">keep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">daily</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">+=</span> <span class="n">prune_split</span><span class="p">(</span><span class="n">archives</span><span class="p">,</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">daily</span><span class="p">,</span> <span class="n">keep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">weekly</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">+=</span> <span class="n">prune_split</span><span class="p">(</span><span class="n">archives</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%G</span><span class="s">-%V&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">weekly</span><span class="p">,</span> <span class="n">keep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">monthly</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">+=</span> <span class="n">prune_split</span><span class="p">(</span><span class="n">archives</span><span class="p">,</span> <span class="s">&#39;%Y-%m&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">monthly</span><span class="p">,</span> <span class="n">keep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">yearly</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">+=</span> <span class="n">prune_split</span><span class="p">(</span><span class="n">archives</span><span class="p">,</span> <span class="s">&#39;%Y&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">yearly</span><span class="p">,</span> <span class="n">keep</span><span class="p">)</span>

        <span class="n">keep</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s">&#39;ts&#39;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">archives</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">]</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">Statistics</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">archive</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_verbose</span><span class="p">(</span><span class="s">&#39;Keeping archive: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">format_archive</span><span class="p">(</span><span class="n">archive</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">archive</span> <span class="ow">in</span> <span class="n">to_delete</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_verbose</span><span class="p">(</span><span class="s">&#39;Would prune:     </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">format_archive</span><span class="p">(</span><span class="n">archive</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_verbose</span><span class="p">(</span><span class="s">&#39;Pruning archive: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">format_archive</span><span class="p">(</span><span class="n">archive</span><span class="p">))</span>
                <span class="n">Archive</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">archive</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">to_delete</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="n">manifest</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">repository</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">stats</span><span class="p">:</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="s">&#39;Deleted data:&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span>
</div>
<div class="viewcode-block" id="Archiver.do_upgrade"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.do_upgrade">[docs]</a>    <span class="k">def</span> <span class="nf">do_upgrade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;upgrade a repository from a previous version&quot;&quot;&quot;</span>
        <span class="c"># XXX: currently only upgrades from Attic repositories, but may</span>
        <span class="c"># eventually be extended to deal with major upgrades for borg</span>
        <span class="c"># itself.</span>
        <span class="c">#</span>
        <span class="c"># in this case, it should auto-detect the current repository</span>
        <span class="c"># format and fire up necessary upgrade mechanism. this remains</span>
        <span class="c"># to be implemented.</span>

        <span class="c"># XXX: should auto-detect if it is an attic repository here</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">AtticRepositoryUpgrader</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">upgrade</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dry_run</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;warning: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span>
</div>
    <span class="n">helptext</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">helptext</span><span class="p">[</span><span class="s">&#39;patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        Exclude patterns use a variant of shell pattern syntax, with &#39;*&#39; matching any</span>
<span class="s">        number of characters, &#39;?&#39; matching any single character, &#39;[...]&#39; matching any</span>
<span class="s">        single character specified, including ranges, and &#39;[!...]&#39; matching any</span>
<span class="s">        character not specified.  For the purpose of these patterns, the path</span>
<span class="s">        separator (&#39;</span><span class="se">\\</span><span class="s">&#39; for Windows and &#39;/&#39; on other systems) is not treated</span>
<span class="s">        specially.  For a path to match a pattern, it must completely match from</span>
<span class="s">        start to end, or must match from the start to just before a path separator.</span>
<span class="s">        Except for the root path, paths will never end in the path separator when</span>
<span class="s">        matching is attempted.  Thus, if a given pattern ends in a path separator, a</span>
<span class="s">        &#39;*&#39; is appended before matching is attempted.  Patterns with wildcards should</span>
<span class="s">        be quoted to protect them from shell expansion.</span>

<span class="s">        Examples:</span>

<span class="s">        # Exclude &#39;/home/user/file.o&#39; but not &#39;/home/user/file.odt&#39;:</span>
<span class="s">        $ borg create -e &#39;*.o&#39; backup /</span>

<span class="s">        # Exclude &#39;/home/user/junk&#39; and &#39;/home/user/subdir/junk&#39; but</span>
<span class="s">        # not &#39;/home/user/importantjunk&#39; or &#39;/etc/junk&#39;:</span>
<span class="s">        $ borg create -e &#39;/home/*/junk&#39; backup /</span>

<span class="s">        # Exclude the contents of &#39;/home/user/cache&#39; but not the directory itself:</span>
<span class="s">        $ borg create -e /home/user/cache/ backup /</span>

<span class="s">        # The file &#39;/home/user/cache/important&#39; is *not* backed up:</span>
<span class="s">        $ borg create -e /home/user/cache/ backup / /home/user/cache/important</span>
<span class="s">        &#39;&#39;&#39;</span>

<div class="viewcode-block" id="Archiver.do_help"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.do_help">[docs]</a>    <span class="k">def</span> <span class="nf">do_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">commands</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">topic</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">helptext</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">helptext</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">topic</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">topic</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">epilog_only</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">topic</span><span class="p">]</span><span class="o">.</span><span class="n">epilog</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">usage_only</span><span class="p">:</span>
                <span class="n">commands</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">topic</span><span class="p">]</span><span class="o">.</span><span class="n">epilog</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">commands</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">topic</span><span class="p">]</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">commands</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">topic</span><span class="p">]</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;No help available on </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">topic</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span>
</div>
<div class="viewcode-block" id="Archiver.preprocess_args"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.preprocess_args">[docs]</a>    <span class="k">def</span> <span class="nf">preprocess_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">deprecations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;--hourly&#39;</span><span class="p">,</span> <span class="s">&#39;--keep-hourly&#39;</span><span class="p">,</span> <span class="s">&#39;Warning: &quot;--hourly&quot; has been deprecated. Use &quot;--keep-hourly&quot; instead.&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;--daily&#39;</span><span class="p">,</span> <span class="s">&#39;--keep-daily&#39;</span><span class="p">,</span> <span class="s">&#39;Warning: &quot;--daily&quot; has been deprecated. Use &quot;--keep-daily&quot; instead.&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;--weekly&#39;</span><span class="p">,</span> <span class="s">&#39;--keep-weekly&#39;</span><span class="p">,</span> <span class="s">&#39;Warning: &quot;--weekly&quot; has been deprecated. Use &quot;--keep-weekly&quot; instead.&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;--monthly&#39;</span><span class="p">,</span> <span class="s">&#39;--keep-monthly&#39;</span><span class="p">,</span> <span class="s">&#39;Warning: &quot;--monthly&quot; has been deprecated. Use &quot;--keep-monthly&quot; instead.&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;--yearly&#39;</span><span class="p">,</span> <span class="s">&#39;--keep-yearly&#39;</span><span class="p">,</span> <span class="s">&#39;Warning: &quot;--yearly&quot; has been deprecated. Use &quot;--keep-yearly&quot; instead.&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;verify&#39;</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: &quot;borg verify&quot; has been deprecated. Use &quot;borg extract --dry-run&quot; instead.&#39;</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;extract&#39;</span><span class="p">,</span> <span class="s">&#39;--dry-run&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">[:]):</span>
            <span class="k">for</span> <span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">deprecations</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">old_name</span><span class="p">):</span>
                    <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span>
</div>
<div class="viewcode-block" id="Archiver.run"><a class="viewcode-back" href="../../api.html#borg.archiver.Archiver.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">check_extension_modules</span><span class="p">()</span>
        <span class="n">keys_dir</span> <span class="o">=</span> <span class="n">get_keys_dir</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">keys_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">keys_dir</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">keys_dir</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXU</span><span class="p">)</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">get_cache_dir</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXU</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="s">&#39;CACHEDIR.TAG&#39;</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">                    Signature: 8a477f597d28d172789f06886806bc55</span>
<span class="s">                    # This file is a cache directory tag created by Borg.</span>
<span class="s">                    # For information about cache directory tags, see:</span>
<span class="s">                    #       http://www.brynosaurus.com/cachedir/</span>
<span class="s">                    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
        <span class="n">common_parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">add_help</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">common_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-v&#39;</span><span class="p">,</span> <span class="s">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                                   <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s">&#39;verbose output&#39;</span><span class="p">)</span>
        <span class="n">common_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--no-files-cache&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;cache_files&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_false&#39;</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s">&#39;do not load/update the file metadata cache used to detect unchanged files&#39;</span><span class="p">)</span>
        <span class="n">common_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--umask&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;umask&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="n">RemoteRepository</span><span class="o">.</span><span class="n">umask</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;M&#39;</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s">&#39;set umask to M (local and remote, default: </span><span class="si">%(default)s</span><span class="s">)&#39;</span><span class="p">)</span>
        <span class="n">common_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--remote-path&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;remote_path&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">RemoteRepository</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;PATH&#39;</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s">&#39;set remote path to executable (default: &quot;</span><span class="si">%(default)s</span><span class="s">&quot;)&#39;</span><span class="p">)</span>

        <span class="c"># We can&#39;t use argparse for &quot;serve&quot; since we don&#39;t want it to show up in &quot;Available commands&quot;</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">&#39;Borg </span><span class="si">%s</span><span class="s"> - Deduplicated Backups&#39;</span> <span class="o">%</span> <span class="n">__version__</span><span class="p">)</span>
        <span class="n">subparsers</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Available commands&#39;</span><span class="p">)</span>

        <span class="n">serve_epilog</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        This command starts a repository server process. This command is usually not used manually.</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">subparser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;serve&#39;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">common_parser</span><span class="p">],</span>
                                          <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_serve</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,</span> <span class="n">epilog</span><span class="o">=</span><span class="n">serve_epilog</span><span class="p">,</span>
                                          <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_serve</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--restrict-to-path&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;restrict_to_paths&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;append&#39;</span><span class="p">,</span>
                               <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;PATH&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;restrict repository access to PATH&#39;</span><span class="p">)</span>
        <span class="n">init_epilog</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        This command initializes an empty repository. A repository is a filesystem</span>
<span class="s">        directory containing the deduplicated data from zero or more archives.</span>
<span class="s">        Encryption can be enabled at repository init time.</span>
<span class="s">        Please note that the &#39;passphrase&#39; encryption mode is DEPRECATED (instead of it,</span>
<span class="s">        consider using &#39;repokey&#39;).</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">subparser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;init&#39;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">common_parser</span><span class="p">],</span>
                                          <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_init</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,</span> <span class="n">epilog</span><span class="o">=</span><span class="n">init_epilog</span><span class="p">,</span>
                                          <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_init</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;repository&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;REPOSITORY&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">location_validator</span><span class="p">(</span><span class="n">archive</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;repository to create&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-e&#39;</span><span class="p">,</span> <span class="s">&#39;--encryption&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;encryption&#39;</span><span class="p">,</span>
                               <span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="s">&#39;keyfile&#39;</span><span class="p">,</span> <span class="s">&#39;repokey&#39;</span><span class="p">,</span> <span class="s">&#39;passphrase&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;select encryption key mode&#39;</span><span class="p">)</span>

        <span class="n">check_epilog</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        The check command verifies the consistency of a repository and the corresponding archives.</span>

<span class="s">        First, the underlying repository data files are checked:</span>

<span class="s">        - For all segments the segment magic (header) is checked</span>
<span class="s">        - For all objects stored in the segments, all metadata (e.g. crc and size) and</span>
<span class="s">          all data is read. The read data is checked by size and CRC. Bit rot and other</span>
<span class="s">          types of accidental damage can be detected this way.</span>
<span class="s">        - If we are in repair mode and a integrity error is detected for a segment,</span>
<span class="s">          we try to recover as many objects from the segment as possible.</span>
<span class="s">        - In repair mode, it makes sure that the index is consistent with the data</span>
<span class="s">          stored in the segments.</span>
<span class="s">        - If you use a remote repo server via ssh:, the repo check is executed on the</span>
<span class="s">          repo server without causing significant network traffic.</span>
<span class="s">        - The repository check can be skipped using the --archives-only option.</span>

<span class="s">        Second, the consistency and correctness of the archive metadata is verified:</span>

<span class="s">        - Is the repo manifest present? If not, it is rebuilt from archive metadata</span>
<span class="s">          chunks (this requires reading and decrypting of all metadata and data).</span>
<span class="s">        - Check if archive metadata chunk is present. if not, remove archive from</span>
<span class="s">          manifest.</span>
<span class="s">        - For all files (items) in the archive, for all chunks referenced by these</span>
<span class="s">          files, check if chunk is present (if not and we are in repair mode, replace</span>
<span class="s">          it with a same-size chunk of zeros). This requires reading of archive and</span>
<span class="s">          file metadata, but not data.</span>
<span class="s">        - If we are in repair mode and we checked all the archives: delete orphaned</span>
<span class="s">          chunks from the repo.</span>
<span class="s">        - if you use a remote repo server via ssh:, the archive check is executed on</span>
<span class="s">          the client machine (because if encryption is enabled, the checks will require</span>
<span class="s">          decryption and this is always done client-side, because key access will be</span>
<span class="s">          required).</span>
<span class="s">        - The archive checks can be time consuming, they can be skipped using the</span>
<span class="s">          --repository-only option.</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">subparser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;check&#39;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">common_parser</span><span class="p">],</span>
                                          <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_check</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,</span>
                                          <span class="n">epilog</span><span class="o">=</span><span class="n">check_epilog</span><span class="p">,</span>
                                          <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_check</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;repository&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;REPOSITORY_OR_ARCHIVE&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">location_validator</span><span class="p">(),</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;repository or archive to check consistency of&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--repository-only&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;repo_only&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                               <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;only perform repository checks&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--archives-only&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;archives_only&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                               <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;only perform archives checks&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--repair&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;repair&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                               <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;attempt to repair any inconsistencies found&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--last&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;last&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;N&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;only check last N archives (Default: all)&#39;</span><span class="p">)</span>

        <span class="n">change_passphrase_epilog</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        The key files used for repository encryption are optionally passphrase</span>
<span class="s">        protected. This command can be used to change this passphrase.</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">subparser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;change-passphrase&#39;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">common_parser</span><span class="p">],</span>
                                          <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_change_passphrase</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,</span>
                                          <span class="n">epilog</span><span class="o">=</span><span class="n">change_passphrase_epilog</span><span class="p">,</span>
                                          <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_change_passphrase</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;repository&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;REPOSITORY&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">location_validator</span><span class="p">(</span><span class="n">archive</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

        <span class="n">create_epilog</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        This command creates a backup archive containing all files found while recursively</span>
<span class="s">        traversing all paths specified. The archive will consume almost no disk space for</span>
<span class="s">        files or parts of files that have already been stored in other archives.</span>

<span class="s">        See the output of the &quot;borg help patterns&quot; command for more help on exclude patterns.</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>

        <span class="n">subparser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">common_parser</span><span class="p">],</span>
                                          <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_create</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,</span>
                                          <span class="n">epilog</span><span class="o">=</span><span class="n">create_epilog</span><span class="p">,</span>
                                          <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_create</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-s&#39;</span><span class="p">,</span> <span class="s">&#39;--stats&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;stats&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;print statistics for the created archive&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="s">&#39;--progress&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;progress&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;print progress while creating the archive&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-e&#39;</span><span class="p">,</span> <span class="s">&#39;--exclude&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;excludes&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">ExcludePattern</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;append&#39;</span><span class="p">,</span>
                               <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;PATTERN&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;exclude paths matching PATTERN&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--exclude-from&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;exclude_files&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s">&#39;r&#39;</span><span class="p">),</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;append&#39;</span><span class="p">,</span>
                               <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;EXCLUDEFILE&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;read exclude patterns from EXCLUDEFILE, one per line&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--exclude-caches&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;exclude_caches&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;exclude directories that contain a CACHEDIR.TAG file (http://www.brynosaurus.com/cachedir/spec.html)&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;--checkpoint-interval&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;checkpoint_interval&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;SECONDS&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;write checkpoint every SECONDS seconds (Default: 300)&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--do-not-cross-mountpoints&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;dontcross&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;do not cross mount points&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--numeric-owner&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;numeric_owner&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;only store numeric user and group identifiers&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--timestamp&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;timestamp&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                               <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;yyyy-mm-ddThh:mm:ss&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;manually specify the archive creation date/time (UTC). &#39;</span>
                                    <span class="s">&#39;alternatively, give a reference file/directory.&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--chunker-params&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;chunker_params&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">ChunkerParams</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">CHUNKER_PARAMS</span><span class="p">,</span>
                               <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;CHUNK_MIN_EXP,CHUNK_MAX_EXP,HASH_MASK_BITS,HASH_WINDOW_SIZE&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;specify the chunker parameters. default: </span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">CHUNKER_PARAMS</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-C&#39;</span><span class="p">,</span> <span class="s">&#39;--compression&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;compression&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">CompressionSpec</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">),</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;COMPRESSION&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;select compression algorithm (and level): &#39;</span>
                                    <span class="s">&#39;none == no compression (default), &#39;</span>
                                    <span class="s">&#39;lz4 == lz4, &#39;</span>
                                    <span class="s">&#39;zlib == zlib (default level 6), &#39;</span>
                                    <span class="s">&#39;zlib,0 .. zlib,9 == zlib (with level 0..9), &#39;</span>
                                    <span class="s">&#39;lzma == lzma (default level 6), &#39;</span>
                                    <span class="s">&#39;lzma,0 .. lzma,9 == lzma (with level 0..9).&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--read-special&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;read_special&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;open and read special files as if they were regular files&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-n&#39;</span><span class="p">,</span> <span class="s">&#39;--dry-run&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;dry_run&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;do not create a backup archive&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;archive&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;ARCHIVE&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">location_validator</span><span class="p">(</span><span class="n">archive</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;name of archive to create (must be also a valid directory name)&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;paths&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;PATH&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;+&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;paths to archive&#39;</span><span class="p">)</span>

        <span class="n">extract_epilog</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        This command extracts the contents of an archive. By default the entire</span>
<span class="s">        archive is extracted but a subset of files and directories can be selected</span>
<span class="s">        by passing a list of ``PATHs`` as arguments. The file selection can further</span>
<span class="s">        be restricted by using the ``--exclude`` option.</span>

<span class="s">        See the output of the &quot;borg help patterns&quot; command for more help on exclude patterns.</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">subparser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;extract&#39;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">common_parser</span><span class="p">],</span>
                                          <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_extract</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,</span>
                                          <span class="n">epilog</span><span class="o">=</span><span class="n">extract_epilog</span><span class="p">,</span>
                                          <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_extract</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-n&#39;</span><span class="p">,</span> <span class="s">&#39;--dry-run&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;dry_run&#39;</span><span class="p">,</span>
                               <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;do not actually change any files&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-e&#39;</span><span class="p">,</span> <span class="s">&#39;--exclude&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;excludes&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">ExcludePattern</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;append&#39;</span><span class="p">,</span>
                               <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;PATTERN&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;exclude paths matching PATTERN&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--exclude-from&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;exclude_files&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s">&#39;r&#39;</span><span class="p">),</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;append&#39;</span><span class="p">,</span>
                               <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;EXCLUDEFILE&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;read exclude patterns from EXCLUDEFILE, one per line&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--numeric-owner&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;numeric_owner&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;only obey numeric user and group identifiers&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--strip-components&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;strip_components&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;NUMBER&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;Remove the specified number of leading path elements. Pathnames with fewer elements will be silently skipped.&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--stdout&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;stdout&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;write all extracted data to stdout&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--sparse&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;sparse&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;create holes in output sparse file from all-zero chunks&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;archive&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;ARCHIVE&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">location_validator</span><span class="p">(</span><span class="n">archive</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;archive to extract&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;paths&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;PATH&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;paths to extract&#39;</span><span class="p">)</span>

        <span class="n">rename_epilog</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        This command renames an archive in the repository.</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">subparser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;rename&#39;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">common_parser</span><span class="p">],</span>
                                          <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_rename</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,</span>
                                          <span class="n">epilog</span><span class="o">=</span><span class="n">rename_epilog</span><span class="p">,</span>
                                          <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_rename</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;archive&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;ARCHIVE&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">location_validator</span><span class="p">(</span><span class="n">archive</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;archive to rename&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;NEWNAME&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;the new archive name to use&#39;</span><span class="p">)</span>

        <span class="n">delete_epilog</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        This command deletes an archive from the repository or the complete repository.</span>
<span class="s">        Disk space is reclaimed accordingly. If you delete the complete repository, the</span>
<span class="s">        local cache for it (if any) is also deleted.</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">subparser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;delete&#39;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">common_parser</span><span class="p">],</span>
                                          <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_delete</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,</span>
                                          <span class="n">epilog</span><span class="o">=</span><span class="n">delete_epilog</span><span class="p">,</span>
                                          <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_delete</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-s&#39;</span><span class="p">,</span> <span class="s">&#39;--stats&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;stats&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;print statistics for the deleted archive&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;--cache-only&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;cache_only&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;delete only the local cache for the given repository&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;target&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;TARGET&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">location_validator</span><span class="p">(),</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;archive or repository to delete&#39;</span><span class="p">)</span>

        <span class="n">list_epilog</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        This command lists the contents of a repository or an archive.</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">subparser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;list&#39;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">common_parser</span><span class="p">],</span>
                                          <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_list</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,</span>
                                          <span class="n">epilog</span><span class="o">=</span><span class="n">list_epilog</span><span class="p">,</span>
                                          <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_list</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--short&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;short&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;only print file/directory names, nothing else&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;src&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;REPOSITORY_OR_ARCHIVE&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">location_validator</span><span class="p">(),</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;repository/archive to list contents of&#39;</span><span class="p">)</span>
        <span class="n">mount_epilog</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        This command mounts an archive as a FUSE filesystem. This can be useful for</span>
<span class="s">        browsing an archive or restoring individual files. Unless the ``--foreground``</span>
<span class="s">        option is given the command will run in the background until the filesystem</span>
<span class="s">        is ``umounted``.</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">subparser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;mount&#39;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">common_parser</span><span class="p">],</span>
                                          <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_mount</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,</span>
                                          <span class="n">epilog</span><span class="o">=</span><span class="n">mount_epilog</span><span class="p">,</span>
                                          <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_mount</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;src&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;REPOSITORY_OR_ARCHIVE&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">location_validator</span><span class="p">(),</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;repository/archive to mount&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;mountpoint&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;MOUNTPOINT&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;where to mount filesystem&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-f&#39;</span><span class="p">,</span> <span class="s">&#39;--foreground&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;foreground&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;stay in foreground, do not daemonize&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-o&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;options&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;Extra mount options&#39;</span><span class="p">)</span>

        <span class="n">info_epilog</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        This command displays some detailed information about the specified archive.</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">subparser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">common_parser</span><span class="p">],</span>
                                          <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_info</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,</span>
                                          <span class="n">epilog</span><span class="o">=</span><span class="n">info_epilog</span><span class="p">,</span>
                                          <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_info</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;archive&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;ARCHIVE&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">location_validator</span><span class="p">(</span><span class="n">archive</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;archive to display information about&#39;</span><span class="p">)</span>

        <span class="n">prune_epilog</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        The prune command prunes a repository by deleting archives not matching</span>
<span class="s">        any of the specified retention options. This command is normally used by</span>
<span class="s">        automated backup scripts wanting to keep a certain number of historic backups.</span>

<span class="s">        As an example, &quot;-d 7&quot; means to keep the latest backup on each day for 7 days.</span>
<span class="s">        Days without backups do not count towards the total.</span>
<span class="s">        The rules are applied from hourly to yearly, and backups selected by previous</span>
<span class="s">        rules do not count towards those of later rules. The time that each backup</span>
<span class="s">        completes is used for pruning purposes. Dates and times are interpreted in</span>
<span class="s">        the local timezone, and weeks go from Monday to Sunday. Specifying a</span>
<span class="s">        negative number of archives to keep means that there is no limit.</span>

<span class="s">        The &quot;--keep-within&quot; option takes an argument of the form &quot;&lt;int&gt;&lt;char&gt;&quot;,</span>
<span class="s">        where char is &quot;H&quot;, &quot;d&quot;, &quot;w&quot;, &quot;m&quot;, &quot;y&quot;. For example, &quot;--keep-within 2d&quot; means</span>
<span class="s">        to keep all archives that were created within the past 48 hours.</span>
<span class="s">        &quot;1m&quot; is taken to mean &quot;31d&quot;. The archives kept with this option do not</span>
<span class="s">        count towards the totals specified by any other options.</span>

<span class="s">        If a prefix is set with -p, then only archives that start with the prefix are</span>
<span class="s">        considered for deletion and only those archives count towards the totals</span>
<span class="s">        specified by the rules.</span>
<span class="s">        Otherwise, *all* archives in the repository are candidates for deletion!</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">subparser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;prune&#39;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">common_parser</span><span class="p">],</span>
                                          <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_prune</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,</span>
                                          <span class="n">epilog</span><span class="o">=</span><span class="n">prune_epilog</span><span class="p">,</span>
                                          <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_prune</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-n&#39;</span><span class="p">,</span> <span class="s">&#39;--dry-run&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;dry_run&#39;</span><span class="p">,</span>
                               <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;do not change repository&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-s&#39;</span><span class="p">,</span> <span class="s">&#39;--stats&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;stats&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;print statistics for the deleted archive&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--keep-within&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;within&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;WITHIN&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;keep all archives within this time interval&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-H&#39;</span><span class="p">,</span> <span class="s">&#39;--keep-hourly&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;hourly&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;number of hourly archives to keep&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-d&#39;</span><span class="p">,</span> <span class="s">&#39;--keep-daily&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;daily&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;number of daily archives to keep&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-w&#39;</span><span class="p">,</span> <span class="s">&#39;--keep-weekly&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;weekly&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;number of weekly archives to keep&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-m&#39;</span><span class="p">,</span> <span class="s">&#39;--keep-monthly&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;monthly&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;number of monthly archives to keep&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-y&#39;</span><span class="p">,</span> <span class="s">&#39;--keep-yearly&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;yearly&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;number of yearly archives to keep&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="s">&#39;--prefix&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;prefix&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;only consider archive names starting with this prefix&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;repository&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;REPOSITORY&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">location_validator</span><span class="p">(</span><span class="n">archive</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;repository to prune&#39;</span><span class="p">)</span>

        <span class="n">upgrade_epilog</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        upgrade an existing Borg repository in place. this currently</span>
<span class="s">        only support converting an Attic repository, but may</span>
<span class="s">        eventually be extended to cover major Borg upgrades as well.</span>

<span class="s">        it will change the magic strings in the repository&#39;s segments</span>
<span class="s">        to match the new Borg magic strings. the keyfiles found in</span>
<span class="s">        $ATTIC_KEYS_DIR or ~/.attic/keys/ will also be converted and</span>
<span class="s">        copied to $BORG_KEYS_DIR or ~/.borg/keys.</span>

<span class="s">        the cache files are converted, from $ATTIC_CACHE_DIR or</span>
<span class="s">        ~/.cache/attic to $BORG_CACHE_DIR or ~/.cache/borg, but the</span>
<span class="s">        cache layout between Borg and Attic changed, so it is possible</span>
<span class="s">        the first backup after the conversion takes longer than expected</span>
<span class="s">        due to the cache resync.</span>

<span class="s">        it is recommended you run this on a copy of the Attic</span>
<span class="s">        repository, in case something goes wrong, for example:</span>

<span class="s">            cp -a attic borg</span>
<span class="s">            borg upgrade -n borg</span>
<span class="s">            borg upgrade borg</span>

<span class="s">        upgrade should be able to resume if interrupted, although it</span>
<span class="s">        will still iterate over all segments. if you want to start</span>
<span class="s">        from scratch, use `borg delete` over the copied repository to</span>
<span class="s">        make sure the cache files are also removed:</span>

<span class="s">            borg delete borg</span>

<span class="s">        the conversion can PERMANENTLY DAMAGE YOUR REPOSITORY! Attic</span>
<span class="s">        will also NOT BE ABLE TO READ THE BORG REPOSITORY ANYMORE, as</span>
<span class="s">        the magic strings will have changed.</span>

<span class="s">        you have been warned.&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">subparser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;upgrade&#39;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">common_parser</span><span class="p">],</span>
                                          <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_upgrade</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,</span>
                                          <span class="n">epilog</span><span class="o">=</span><span class="n">upgrade_epilog</span><span class="p">,</span>
                                          <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_upgrade</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-n&#39;</span><span class="p">,</span> <span class="s">&#39;--dry-run&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;dry_run&#39;</span><span class="p">,</span>
                               <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;do not change repository&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;repository&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;REPOSITORY&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">location_validator</span><span class="p">(</span><span class="n">archive</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;path to the repository to be upgraded&#39;</span><span class="p">)</span>

        <span class="n">subparser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;help&#39;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">common_parser</span><span class="p">],</span>
                                          <span class="n">description</span><span class="o">=</span><span class="s">&#39;Extra help&#39;</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--epilog-only&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;epilog_only&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--usage-only&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;usage_only&#39;</span><span class="p">,</span>
                               <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">do_help</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">choices</span><span class="p">))</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;topic&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;TOPIC&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;?&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;additional help on TOPIC&#39;</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[</span><span class="s">&#39;-h&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span>
        <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">umask</span><span class="p">)</span>
        <span class="n">RemoteRepository</span><span class="o">.</span><span class="n">remote_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">remote_path</span>
        <span class="n">RemoteRepository</span><span class="o">.</span><span class="n">umask</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">umask</span>
        <span class="n">update_excludes</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="sig_info_handler"><a class="viewcode-back" href="../../api.html#borg.archiver.sig_info_handler">[docs]</a><span class="k">def</span> <span class="nf">sig_info_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>  <span class="c"># pragma: no cover</span>
    <span class="sd">&quot;&quot;&quot;search the stack for infos about the currently processed file and print them&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getouterframes</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">f_locals</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;process_file&#39;</span><span class="p">,</span> <span class="s">&#39;_process&#39;</span><span class="p">,</span> <span class="p">):</span>  <span class="c"># create op</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">loc</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">loc</span><span class="p">[</span><span class="s">&#39;fd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="n">total</span> <span class="o">=</span> <span class="n">loc</span><span class="p">[</span><span class="s">&#39;st&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">st_size</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">pos</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{0} {1}/{2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">format_file_size</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="n">format_file_size</span><span class="p">(</span><span class="n">total</span><span class="p">)))</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;extract_item&#39;</span><span class="p">,</span> <span class="p">):</span>  <span class="c"># extract op</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">loc</span><span class="p">[</span><span class="s">&#39;item&#39;</span><span class="p">][</span><span class="n">b</span><span class="s">&#39;path&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">loc</span><span class="p">[</span><span class="s">&#39;fd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{0} {1}/???&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">format_file_size</span><span class="p">(</span><span class="n">pos</span><span class="p">)))</span>
            <span class="k">break</span>

</div>
<div class="viewcode-block" id="setup_signal_handlers"><a class="viewcode-back" href="../../api.html#borg.archiver.setup_signal_handlers">[docs]</a><span class="k">def</span> <span class="nf">setup_signal_handlers</span><span class="p">():</span>  <span class="c"># pragma: no cover</span>
    <span class="n">sigs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;SIGUSR1&#39;</span><span class="p">):</span>
        <span class="n">sigs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">)</span>  <span class="c"># kill -USR1 pid</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;SIGINFO&#39;</span><span class="p">):</span>
        <span class="n">sigs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINFO</span><span class="p">)</span>  <span class="c"># kill -INFO pid (or ctrl-t)</span>
    <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">sigs</span><span class="p">:</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">sig_info_handler</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../api.html#borg.archiver.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>  <span class="c"># pragma: no cover</span>
    <span class="c"># Make sure stdout and stderr have errors=&#39;replace&#39;) to avoid unicode</span>
    <span class="c"># issues when print()-ing unicode file names</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="s">&#39;replace&#39;</span><span class="p">,</span> <span class="n">line_buffering</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="s">&#39;replace&#39;</span><span class="p">,</span> <span class="n">line_buffering</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">setup_signal_handlers</span><span class="p">()</span>
    <span class="n">archiver</span> <span class="o">=</span> <span class="n">Archiver</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="n">archiver</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">archiver</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get_message</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">exit_code</span>
    <span class="k">except</span> <span class="n">RemoteRepository</span><span class="o">.</span><span class="n">RPCError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">archiver</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&#39;Error: Remote Exception.</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">archiver</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&#39;Error: Local Exception.</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">archiver</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&#39;Error: Keyboard interrupt.</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">exit_code</span><span class="p">:</span>
        <span class="n">archiver</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s">&#39;Exiting with failure status due to previous errors&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">exit_code</span><span class="p">)</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="sidebarlogo">
  <a href="../../index.html">
  <div class="title">Borg</div>
</a>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><a href="https://github.com/borgbackup/borg"><img style="position: fixed; top: 0; right: 0; border: 0;"
  src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://borgbackup.github.io/borgbackup/">Main Web Site</a></li>
  <li><a href="https://pypi.python.org/pypi/borgbackup">PyPI packages</a></li>
  <li><a href="https://github.com/borgbackup/borg/issues/214">Binaries</a></li>
  <li><a href="https://github.com/borgbackup/borg/blob/master/CHANGES.rst">Current ChangeLog</a></li>
  <li><a href="https://github.com/borgbackup/borg">GitHub</a></li>
  <li><a href="https://github.com/borgbackup/borg/issues">Issue Tracker</a></li>
  <li><a href="https://www.bountysource.com/teams/borgbackup">Bounties &amp; Fundraisers</a></li>
  <li><a href="http://librelist.com/browser/borgbackup/">Mailing List</a></li>
</ul>

<h3>Related Projects</h3>
<ul>
  <li><a href="https://borgbackup.github.io/borgweb/">BorgWeb</a></li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Borg - Deduplicating Archiver 0.27.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>